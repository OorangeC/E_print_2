# 后端启动指南（从 GitHub 拉取代码后）

## 📦 前置准备

确保已安装：
- Node.js (推荐 v18 或更高)
- MySQL (需要运行中)
- MongoDB (需要运行中)

## 🚀 启动步骤

### 1️⃣ 安装依赖

**必须执行！** 因为添加了新的依赖包（mysql2, mongodb, ts-node 等）

```bash
# 进入后端目录
cd backend

# 安装依赖
npm install
```

### 2️⃣ 配置环境变量

检查 `backend/.env` 文件是否存在并配置正确：

```env
# MySQL 配置
MYSQL_URL="mysql://root:你的密码@localhost:3306/E_Bench"

# MongoDB 配置
MONGODB_URL="mongodb://localhost:27017/E_Bench_Logs"

# 端口配置
PORT=3000
```

### 3️⃣ 初始化数据库

**首次启动或数据库结构有更新时必须执行：**

```bash
# 方法1：使用自动重置脚本（推荐）
npm run db:reset    # 删除并重建 MySQL 和 MongoDB 数据库
npm run db:push     # 创建所有表结构

# 方法2：手动操作（如果自动脚本失败）
# 在 MySQL 中执行：
DROP DATABASE IF EXISTS E_Bench;
CREATE DATABASE E_Bench CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 在 MongoDB shell 中执行：
use E_Bench_Logs;
db.dropDatabase();

# 然后运行：
npm run db:push
```

### 4️⃣ 启动后端服务

```bash
npm run dev
```

看到以下信息表示启动成功：
```
Server is running on port 3000
```

---

## 🔧 常用命令

```bash
# 开发模式（热重载）
npm run dev

# 生成 Prisma 客户端
npm run db:generate

# 推送数据库结构
npm run db:push

# 重置数据库（清空所有数据）
npm run db:reset

# 查看数据库（可视化界面）
npm run db:studio
```

---

## 📋 前端启动步骤

如果前端代码也有更新：

```bash
# 在项目根目录
npm install   # 安装/更新前端依赖
npm run dev   # 启动前端开发服务器
```

前端默认运行在：http://localhost:5173

---

## ⚠️ 常见问题

### Q1: `npm install` 报错？
**解决**：删除 `node_modules` 和 `package-lock.json`，重新运行 `npm install`

### Q2: 数据库连接失败？
**解决**：
1. 确认 MySQL 和 MongoDB 服务正在运行
2. 检查 `.env` 文件中的数据库密码
3. 确认数据库已创建（运行 `npm run db:reset`）

### Q3: Prisma 报错 "Unknown field" 或 "Unknown argument"？
**解决**：
```bash
npm run db:reset    # 重置数据库
npm run db:push     # 重新推送结构
```

### Q4: 端口 3000 被占用？
**解决**：修改 `.env` 中的 `PORT` 为其他端口，如 3001

---

## 🎯 本次更新重点

### 数据库枚举使用中文
订单和工单状态现在直接使用中文：
- `'草稿'`, `'待审核'`, `'通过'`, `'驳回'`, `'生产中'`, `'完成'`, `'取消'`

### 新增依赖
- `mysql2`: MySQL 数据库操作
- `mongodb`: MongoDB 数据库操作  
- `ts-node`: 运行 TypeScript 脚本

### 删除了所有状态映射转换逻辑
前后端现在直接使用相同的中文枚举值，无需转换！

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. ✅ MySQL 和 MongoDB 是否正在运行
2. ✅ `.env` 配置是否正确
3. ✅ 是否执行了 `npm install`
4. ✅ 是否执行了 `npm run db:reset` 和 `npm run db:push`
